chrome.runtime.onMessage.addListener((t,n,o)=>(console.log("[CV-Tailor] Received message:",t.type),T(t,o),!0));async function T(t,n){try{switch(t.type){case"DETECT_JD":const o=x();console.log("[CV-Tailor] Detection result:",{jdLength:o.jd.length,title:o.jobTitle,company:o.company,method:o.method}),n({success:!0,data:o});break;case"FILL_FORM":console.log("[CV-Tailor] Filling form with data:",Object.keys(t.data));const e=await A(t.data);console.log("[CV-Tailor] Filled",e,"fields"),n({success:!0,data:{filledCount:e}});break;case"GET_FORM_FIELDS":const r=q();n({success:!0,data:r});break;case"PING":n({success:!0,data:"pong"});break;default:n({success:!1,error:"Unknown message type"})}}catch(o){console.error("[CV-Tailor] Error:",o),n({success:!1,error:o.message})}}function x(){const t=w();if(t&&t.description&&t.description.length>200)return console.log("[CV-Tailor] Using Schema.org detection"),{jd:t.description,jobTitle:t.title||p()||"",company:t.company||f()||"",method:"schema_org"};const n=_();if(n.description&&n.description.length>200)return console.log("[CV-Tailor] Using meta tag detection"),{jd:n.description,jobTitle:n.title||p()||"",company:f()||"",method:"meta_tags"};const o=S(),e=L();return{jd:o,jobTitle:e.jobTitle,company:e.company,method:"css_selectors"}}function w(){try{const t=document.querySelectorAll('script[type="application/ld+json"]');for(const n of t){const o=n.textContent;if(o)try{const e=JSON.parse(o),r=d(e);if(r)return{title:g(r.title),company:v(r.hiringOrganization),description:E(g(r.description)||""),location:h(r.jobLocation)}}catch{continue}}}catch(t){console.error("[CV-Tailor] Schema.org detection error:",t)}return null}function d(t){if(!t)return null;if(t["@type"]==="JobPosting"||Array.isArray(t["@type"])&&t["@type"].includes("JobPosting"))return t;if(Array.isArray(t["@graph"]))for(const n of t["@graph"]){const o=d(n);if(o)return o}if(Array.isArray(t))for(const n of t){const o=d(n);if(o)return o}return null}function g(t){if(typeof t=="string")return t;if(typeof t=="object"&&t!==null)return t["@value"]||t.value||t.name}function v(t){if(t)return typeof t=="string"?t:t.name||t.legalName}function h(t){if(t){if(typeof t=="string")return t;if(t.address){const n=t.address;return[n.addressLocality,n.addressRegion,n.addressCountry].filter(Boolean).join(", ")}return Array.isArray(t)?t.map(n=>h(n)).filter(Boolean).join(" | "):t.name}}function _(){const t={title:"",description:""},n=document.querySelector('meta[property="og:title"]'),o=document.querySelector('meta[property="og:description"]');if(n&&(t.title=n.getAttribute("content")||""),o&&(t.description=o.getAttribute("content")||""),!t.title){const e=document.querySelector('meta[name="twitter:title"]');e&&(t.title=e.getAttribute("content")||"")}if(!t.description){const e=document.querySelector('meta[name="twitter:description"]');e&&(t.description=e.getAttribute("content")||"")}if(!t.description){const e=document.querySelector('meta[name="description"]');e&&(t.description=e.getAttribute("content")||"")}return t}function S(){const t=['[class*="job-description"]','[class*="job_description"]','[class*="jobDescription"]','[id*="job-description"]','[id*="job_description"]','[data-testid*="description"]','[data-automation-id*="description"]','[data-automation-id="jobPostingDescription"]',".job-posting-section",'[data-automation-id="jobReqDescriptionSection"]',"#content .job-description",".job-content",".content-intro",".posting-headline",".content .posting-categories + div",'[data-qa="job-description"]',".description__text",".jobs-description",".job-view-layout",".jobs-description-content__text",".jobs-box__html-content","#jobDescriptionText",".jobsearch-jobDescriptionText",'[id*="jobDetails"]',".desc",".eeOeq",'[data-test="jobDescriptionContent"]',".job-desc",".jd-desc",'[class*="jd-container"]',".job-description","#JobDescription",".job_description",'[class*="job-description"]',".job-description","#jobDescription",'[class*="description"]',".jobs-overview",".job-sections",'[class*="jobDetails"]',".iCIMS_JobContent",".iCIMS_InfoMsg_Job",".job-description",'[id*="requisitionDesc"]','[role="main"]',"main","article"];for(const r of t)try{const i=document.querySelector(r);if(i&&i.textContent&&i.textContent.length>200)return c(i.textContent)}catch{}const o=(document.querySelector("main")||document.querySelector("#main")||document.body).querySelectorAll("p, div, section");let e="";for(const r of o){const i=r.textContent||"";i.length>e.length&&i.length>500&&(i.toLowerCase().includes("responsibilities")||i.toLowerCase().includes("requirements")||i.toLowerCase().includes("qualifications")||i.toLowerCase().includes("experience"))&&(e=i)}if(e.length>200)return c(e);for(const r of o){const i=r.textContent||"";i.length>e.length&&i.length>500&&(e=i)}return c(e)}function p(){const t=["h1",'[class*="job-title"]','[class*="jobTitle"]','[data-testid*="title"]',".posting-headline h2",".jobs-details-top-card__job-title",".top-card-layout__title",'[data-automation-id="jobPostingTitle"]',".job-title",'[class*="title"]'];for(const n of t)try{const o=document.querySelector(n);if(o&&o.textContent&&o.textContent.length>2&&o.textContent.length<150){const e=c(o.textContent);if(!e.toLowerCase().includes("menu")&&!e.toLowerCase().includes("search"))return e}}catch{continue}return""}function f(){const t=['[class*="company-name"]','[class*="companyName"]','[class*="company_name"]','[data-testid*="company"]',".posting-categories .company",".jobs-details-top-card__company-url",".employer-name",".top-card-layout__second-subline",'[data-automation-id="jobPostingHeader"]','[class*="employer"]','[class*="organization"]'];for(const n of t)try{const o=document.querySelector(n);if(o&&o.textContent&&o.textContent.length>1&&o.textContent.length<100)return c(o.textContent)}catch{continue}return""}function L(){let t=p(),n=f();if(!t||!n){const e=document.title.match(/^(.+?)\s+(?:at|@|-|–|—|\|)\s+(.+?)(?:\s+[-|]|$)/i);e&&(t||(t=e[1].trim()),n||(n=e[2].trim()))}return{jobTitle:t,company:n}}function q(){const t=[],n=document.querySelectorAll("input, textarea, select");for(const o of n){const e=o;if(e.type==="hidden"||e.type==="submit"||e.type==="button")continue;let r="";const i=document.querySelector(`label[for="${e.id}"]`);if(i)r=i.textContent||"";else{const l=e.closest("div, fieldset, label");if(l){const s=l.querySelector("label, span, div");s&&s!==e&&(r=s.textContent||"")}}t.push({name:e.name||e.id||"",type:e.tagName.toLowerCase()+(e.type?`-${e.type}`:""),label:c(r).slice(0,100),value:e.value||""})}return t}async function A(t){const n={firstName:["first_name","firstname","fname","first-name","given","first name","givenname"],lastName:["last_name","lastname","lname","last-name","surname","family","last name","familyname"],email:["email","e-mail","emailaddress","e_mail","mail"],phone:["phone","telephone","tel","mobile","cell","phonenumber","phone number"],linkedin:["linkedin","linked-in","linked_in","linkedinurl"],github:["github","git-hub","githuburl"],portfolio:["portfolio","website","url","personal","personalwebsite","personalurl","web"],coverLetter:["cover","letter","coverletter","cover_letter","cover letter","motivation"]};let o=0;const e=document.querySelectorAll("input, textarea");console.log("[CV-Tailor] Found",e.length,"input fields");for(const r of e){const i=r;if(i.type==="hidden"||i.type==="submit"||i.type==="file"||i.type==="checkbox"||i.type==="radio")continue;const l=[i.name,i.id,i.placeholder,i.className,i.getAttribute("aria-label"),i.getAttribute("data-testid")].filter(Boolean).join(" ").toLowerCase();let s="";const m=document.querySelector(`label[for="${i.id}"]`);if(m)s=(m.textContent||"").toLowerCase();else{const a=i.closest("div, fieldset, label, section");if(a){const u=a.querySelector("label, span.label, div.label");u&&(s=(u.textContent||"").toLowerCase())}}const j=l+" "+s;let b=!1;for(const[a,u]of Object.entries(n)){if(b)break;const y=t[a];if(y){for(const C of u)if(j.includes(C)){console.log("[CV-Tailor] Filling field:",i.name||i.id,"with",a),await D(i,y),o++,b=!0;break}}}}return o}async function D(t,n){var r,i;if(t.value&&t.value.trim()){console.log("[CV-Tailor] Skipping field (has value):",t.name||t.id);return}t.focus(),t.value="";const o=(r=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value"))==null?void 0:r.set,e=(i=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:i.set;t instanceof HTMLInputElement&&o?o.call(t,n):t instanceof HTMLTextAreaElement&&e?e.call(t,n):t.value=n,t.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),t.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0})),t.dispatchEvent(new KeyboardEvent("keyup",{bubbles:!0})),t.dispatchEvent(new Event("blur",{bubbles:!0})),await new Promise(l=>setTimeout(l,100))}function c(t){return t.replace(/\s+/g," ").replace(/\n+/g,`
`).trim()}function E(t){const n=document.createElement("div");return n.innerHTML=t,n.querySelectorAll("script, style").forEach(e=>e.remove()),c(n.textContent||"")}console.log("[CV-Tailor] Content script loaded on:",window.location.hostname);
